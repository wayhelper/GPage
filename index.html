<!--
<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>GSearch</title>
        <link rel="stylesheet" href="./css/style.css">
        <script src="./js/crypto-js.min.js"></script>
    </head>
    <body>

        <h1>WellCome Use GSearch</h1>
        <input type="text" id="searchBox" placeholder="Search..." oninput="filterCards()">
        <div class="card-container" id="navCards"></div>
        <script src="./js/style.js"></script>

    </body>
</html>-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GSearch - Vue版本</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* 通用样式 */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 5vh 2vw;
            background: linear-gradient(to right, #ece9e6, #ffffff);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 标题 */
        h1 {
            font-size: 2rem;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            animation: textColorChange 5s infinite linear;
        }

        /* 动态文字颜色动画 */
        @keyframes textColorChange {
            0% { color: #FF6F61; }
            25% { color: #6B5B95; }
            50% { color: #88B04B; }
            75% { color: #F7CAC9; }
            100% { color: #FF6F61; }
        }

        /* 搜索框 */
        .search-box {
            width: 80%;
            max-width: 600px;
            padding: 10px 15px;
            font-size: 1rem;
            border: 2px solid #ccc;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        /* 卡片容器 */
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            width: 90%;
            max-width: 1000px;
        }

        /* 卡片 */
        .card {
            background: #ffffff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            animation: cardTextColorChange 5s infinite linear;
        }

        /* 卡片动态文字颜色动画 */
        @keyframes cardTextColorChange {
            0% { color: #333333; }
            50% { color: #FF6F61; }
            100% { color: #333333; }
        }

        /* 卡片悬停效果 */
        .card:hover {
            background: #FF6F61;
            color: #ffffff;
            transform: scale(1.05);
            animation: none;
        }

        /* 模态框样式 */
        .modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-content {
            background: white;
            padding: 20px;
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
        }

        .modal-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .modal-button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .save-button {
            background: #4CAF50;
            color: white;
        }

        .close-button {
            background: #ccc;
        }

        textarea {
            width: 100%;
            height: 300px;
            margin-bottom: 10px;
            resize: vertical;
        }
    </style>
</head>
<body>
<div id="app">
    <h1 @click="handleTitleClick">WellCome Use GSearch</h1>

    <input
            type="text"
            class="search-box"
            placeholder="Search..."
            v-model="searchQuery"
            ref="searchInput"
    >

    <div class="card-container">
        <div
                v-for="item in filteredNavData"
                :key="item.name"
                class="card"
                @click="openLink(item.url)"
        >
            {{ item.name }}
        </div>
    </div>

    <!-- 编辑模态框 -->
    <div v-if="showModal" class="modal">
        <div class="modal-content">
            <h3>编辑导航 JSON</h3>
            <textarea v-model="editJson"></textarea>
            <div class="modal-buttons">
                <button class="modal-button save-button" @click="saveJson">保存</button>
                <button class="modal-button close-button" @click="closeModal">关闭</button>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // 响应式数据
            const navData = ref([]);
            const searchQuery = ref('');
            const showModal = ref(false);
            const editJson = ref('');
            const clickCount = ref(0);
            const clickTimer = ref(null);
            const searchInput = ref(null);

            // 计算属性 - 过滤后的导航数据
            const filteredNavData = computed(() => {
                if (!searchQuery.value) {
                    return navData.value;
                }

                const query = searchQuery.value.toLowerCase();
                return navData.value.filter(item =>
                    item.name.toLowerCase().includes(query)
                );
            });

            // 方法
            const loadNavData = async () => {
                try {
                    const res = await fetch('/nav');
                    navData.value = await res.json();
                } catch (err) {
                    console.error('加载导航数据失败', err);
                }
            };

            const openLink = (url) => {
                window.open(url, '_blank', 'noopener,noreferrer');
            };

            const handleTitleClick = async () => {
                clickCount.value++;

                if (clickTimer.value) {
                    clearTimeout(clickTimer.value);
                }

                clickTimer.value = setTimeout(() => {
                    clickCount.value = 0;
                }, 800);

                if (clickCount.value >= 5) {
                    clickCount.value = 0;
                    const res = await fetch('/nav');
                    const json = await res.text();
                    editJson.value = json;
                    showModal.value = true;
                }
            };

            const closeModal = () => {
                showModal.value = false;
            };

            const saveJson = async () => {
                let token = prompt("请输入密钥以保存：");
                if (!token) {
                    alert("密钥不能为空！");
                    return;
                }

                try {
                    const response = await fetch('pwd.txt');
                    const text = await response.text();
                    let pwd = decrypt(text.trim(), token);

                    if (pwd !== token) {
                        alert("认证失败！");
                    } else {
                        await fetch('/nav', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: editJson.value
                        });
                        alert('已保存');
                        showModal.value = false;
                        await loadNavData();
                    }
                } catch (error) {
                    console.error("认证过程出错", error);
                    alert("认证过程出错");
                }
            };

            // 工具函数
            const hexStr2ByteArr = (hexStr) => {
                let bytes = [];
                for (let i = 0; i < hexStr.length; i += 2) {
                    bytes.push(parseInt(hexStr.substr(i, 2), 16));
                }
                return new Uint8Array(bytes);
            };

            const getKey = (keyStr) => {
                let keyBytes = CryptoJS.enc.Utf8.parse(keyStr);
                return CryptoJS.lib.WordArray.create(keyBytes.words.slice(0, 2));
            };

            const decrypt = (encryptedText, key) => {
                let encryptedBytes = hexStr2ByteArr(encryptedText);
                let encryptedWordArray = CryptoJS.lib.WordArray.create(encryptedBytes);
                let decrypted = CryptoJS.DES.decrypt({ ciphertext: encryptedWordArray }, getKey(key), {
                    mode: CryptoJS.mode.ECB,
                    padding: CryptoJS.pad.Pkcs7,
                });
                return decrypted.toString(CryptoJS.enc.Utf8);
            };

            // 生命周期
            onMounted(() => {
                loadNavData();
                nextTick(() => {
                    if (searchInput.value) {
                        searchInput.value.focus();
                    }
                });
            });

            // 返回模板中需要使用的数据和方法
            return {
                navData,
                searchQuery,
                showModal,
                editJson,
                searchInput,
                filteredNavData,
                openLink,
                handleTitleClick,
                closeModal,
                saveJson,
                decrypt
            };
        }
    }).mount('#app');
</script>
</body>
</html>